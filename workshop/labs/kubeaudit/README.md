# Kubeaudit: Audit your Kubernetes clusters against common security controls

## Quick Start

`kubeaudit` is a command line tool and a Go package to audit Kubernetes clusters for various different security concerns.

1. Installation.

    Install on your system

    ```bash
    # Download binary
    wget https://github.com/Shopify/kubeaudit/releases/download/v0.22.0/kubeaudit_0.22.0_linux_amd64.tar.gz
    tar -xzf kubeaudit_0.22.0_linux_amd64.tar.gz
    ./kubeaudit --help
    # Install via brew
    brew install kubeaudit
    ```

2. Run `kubeaudit` command and get familiar with it.

    ```bash
    kubeaudit

    Kubeaudit audits Kubernetes clusters for common security controls.

    kubeaudit has three modes:
    1. Manifest mode: If a Kubernetes manifest file is provided using the -f/--manifest flag, kubeaudit will audit the manifest file. Kubeaudit also supports autofixing in manifest mode using the 'autofix' command. This will fix the manifest in-place. The fixed manifest can be written to a different file using the -o/--out flag.
    2. Cluster mode: If kubeaudit detects it is running in a cluster, it will audit the other resources in the cluster.
    3. Local mode: kubeaudit will try to connect to a cluster using the local kubeconfig file ($HOME/.kube/config). A different kubeconfig location can be specified using the -c/--kubeconfig flag

    Usage:
    kubeaudit [command]

    Available Commands:
    all            Run all audits
    apparmor       Audit containers running without AppArmor
    asat           Audit pods using an automatically mounted default service account
    autofix        Automagically make a manifest secure
    capabilities   Audit containers not dropping ALL capabilities
    completion     Generate the autocompletion script for the specified shell
    deprecatedapis Audit resource API version deprecations
    help           Help about any command
    hostns         Audit pods with hostNetwork, hostIPC or hostPID enabled
    image          Audit containers not using a specified image:tag
    limits         Audit containers exceeding a specified CPU or memory limit
    mounts         Audit containers that mount sensitive paths
    netpols        Audit namespaces that do not have a default deny network policy
    nonroot        Audit containers allowing for root user
    privesc        Audit containers that allow privilege escalation
    privileged     Audit containers running as privileged
    rootfs         Audit containers not using a read only root filesystems
    seccomp        Audit containers running without Seccomp
    version        Prints the current kubeaudit version

    Flags:
    -c, --context string       The name of the kubeconfig context to use
    -e, --exitcode int         Exit code to use if there are results with severity of "error". Conventionally, 0 is used for success and all non-zero codes for an error. (default 2)
    -p, --format string        The output format to use (one of "sarif","pretty", "logrus", "json") (default "pretty")
    -h, --help                 help for kubeaudit
    -g, --includegenerated     Include generated resources in scan  (eg. pods generated by deployments).
        --kubeconfig string    Path to local Kubernetes config file. Only used in local mode (default is $HOME/.kube/config)
    -f, --manifest string      Path to the yaml configuration to audit. Only used in manifest mode.
    -m, --minseverity string   Set the lowest severity level to report (one of "error", "warning", "info") (default "info")
    -n, --namespace string     Only audit resources in the specified namespace. Not currently supported in manifest mode.
        --no-color             Don't produce colored output.

    Use "kubeaudit [command] --help" for more information about a command.
    ```

3. Use `kubeaudit` to scan for vulnerabilities in the `wordpress` application

    ```bash
    # wordpress deployment
    kubeaudit all -f wordpress/wordpress-deployment.yaml
    # mysql deployment
    kubeaudit all -f wordpress/mysql-deployment.yaml
    ```

4. Use `kubeaudit` to fix vulnerabilities in the `wordpress` application

    ```bash
    # wordpress deployment
    kubeaudit autofix -f "wordpress/wordpress-deployment.yaml" -o "wordpress/wordpress-deployment.fixed.yaml"
    diff -y wordpress/wordpress-deployment.yaml wordpress/wordpress-deployment.fixed.yaml
    # mysql deployment
    kubeaudit autofix -f "wordpress/mysql-deployment.yaml" -o "wordpress/mysql-deployment.fixed.yaml"
    diff -y wordpress/mysql-deployment.yaml wordpress/mysql-deployment.fixed.yaml
    ```

5. Use `kubeaudit` to do dynamic analysis against a Kubernetes cluster

    ```bash
    # run kubeaudit against local kind (k8s) cluster
    kubeaudit all --kubeconfig ~/.kube/config
    ```

6. Run `kubeaudit` as a job inside a Kubernetes cluster

    ```bash
    # deploy wordpress and mysql services
    kubectl create secret generic mysql-pass --from-literal=password=changeme
    kubectl apply -f wordpress/mysql-deployment.yaml
    kubectl apply -f wordpress/wordpress-deployment.yaml
    # deploy kubeaudit job
    kubectl apply -f kubeaudit-job.yaml
    # inspect kubeaudit logs
    kubectl logs -l job-name=kubeaudit --tail=-1
    ```

7. Finalize the lab

    ```bash
    # end the lab
    kubectl delete secret mysql-pass
    kubectl delete -f kubeaudit-job.yaml
    kubectl delete -f wordpress/mysql-deployment.yaml
    kubectl delete -f wordpress/wordpress-deployment.yaml
    kubectl delete secret mysql-pass
    ```

## Resources

- <https://github.com/Shopify/kubeaudit>
